// ets_tracing: off
import * as Tp from "../Collections/Immutable/Tuple/index.js";
import * as Ex from "../Exit/index.js";
import * as F from "../Fiber/index.js";
import { releaseAll, ReleaseMap, Running } from "../Managed/ReleaseMap/index.js";
import * as P from "../Promise/index.js";
import * as Ref from "../Ref/index.js";
import * as L from "./core.js";
import * as T from "./deps-effect.js";
export class MainProvider {
  constructor(allocate, release, provide) {
    this.allocate = allocate;
    this.release = release;
    this.provide = provide;
  }

}
/**
 * Unsafely returns a `MainProvider` to be used in frontend-like
 * contexts where initialization needs to be global and sync
 */

export function unsafeMainProvider(self) {
  const promise = P.unsafeMake(F.None);
  const relMap = new ReleaseMap(Ref.unsafeMakeRef(new Running(0, new Map())));
  return new MainProvider(T.foldCauseM_(T.map_(T.provideSome_(L.build(self["+++"](L.identity())).effect, r => Tp.tuple(r, relMap)), _ => _.get(1)), cause => T.chain_(P.halt_(promise, cause), () => T.halt(cause)), r => P.succeed(r)(promise)), T.descriptorWith(d => T.asUnit(releaseAll(Ex.interrupt(d.id), T.sequential)(relMap))), self => T.chain_(P.await(promise), env => T.provide_(self, env)));
}
//# sourceMappingURL=unsafe.js.map